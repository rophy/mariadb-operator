apiVersion: skaffold/v4beta13
kind: Config
metadata:
  name: mariadb-operator
build:
  artifacts:
    - image: mariadb-operator
      docker:
        dockerfile: Dockerfile
        buildArgs:
          TARGETOS: linux
          TARGETARCH: amd64
      platforms:
        - linux/amd64
    - image: mariadb-test-client
      context: test/client
      docker:
        dockerfile: Dockerfile
      platforms:
        - linux/amd64
  tagPolicy:
    gitCommit:
      variant: AbbrevCommitSha
manifests:
  helm:
    releases:
      # Install CRDs first
      - name: mariadb-operator-crds
        chartPath: deploy/charts/mariadb-operator-crds
        namespace: mariadb-system
        createNamespace: true
        upgradeOnChange: true
        wait: true
        setValueTemplates:
          # CRDs should be kept up to date
        version: 25.10.2

      # Install the operator
      - name: mariadb-operator
        chartPath: deploy/charts/mariadb-operator
        namespace: mariadb-system
        createNamespace: true
        upgradeOnChange: true
        wait: true
        setValueTemplates:
          # Use the built image
          image.repository: mariadb-operator
          image.tag: "{{.IMAGE_TAG}}"
          image.pullPolicy: IfNotPresent
        setValues:
          # Disable webhook for simpler local development
          webhook.enabled: false
          # Disable cert-controller (webhook dependency)
          certController.enabled: false
          # Log level for debugging
          logLevel: DEBUG
          # Disable high availability for local dev
          ha.enabled: false
        version: 25.10.2

      # Deploy a single MariaDB instance
      - name: mariadb-cluster
        chartPath: deploy/charts/mariadb-cluster
        namespace: default
        createNamespace: false
        upgradeOnChange: true
        wait: true
        setValues:
          # Simple standalone MariaDB (not Galera cluster)
          mariadb.replicas: 1
          mariadb.galera.enabled: false
          mariadb.storage.size: 2Gi
          mariadb.rootPasswordSecretKeyRef.name: mariadb
          mariadb.rootPasswordSecretKeyRef.key: root-password
          # Create test database automatically via Database CR
          databases:
            - name: test
              characterSet: utf8mb4
              collate: utf8mb4_unicode_ci
        version: 25.10.2

      # Deploy test client
      - name: mariadb-test-client
        chartPath: test/client/chart
        namespace: default
        createNamespace: false
        upgradeOnChange: true
        wait: false
        setValueTemplates:
          image: "{{.IMAGE_FULLY_QUALIFIED_mariadb_test_client}}"
        setValues:
          imagePullPolicy: IfNotPresent
          mariadb.host: mariadb-cluster
          mariadb.port: 3306
          mariadb.user: root
          mariadb.passwordSecret.name: mariadb
          mariadb.passwordSecret.key: root-password
          mariadb.database: test
          client.writeInterval: 1.0

deploy:
  helm:
    hooks:
      before:
        - host:
            command:
              - sh
              - -c
              - |
                # Create password secrets if they don't exist
                kubectl create secret generic mariadb \
                  --from-literal=root-password=mariadb-root-password \
                  --from-literal=app-password=mariadb-app-password \
                  --namespace=default \
                  --dry-run=client -o yaml | kubectl apply -f -

portForward:
  - resourceType: service
    resourceName: mariadb-operator
    namespace: mariadb-system
    port: 8080
    localPort: 8080
  - resourceType: service
    resourceName: mariadb-cluster
    namespace: default
    port: 3306
    localPort: 3306

profiles:
  # Profile for installing Istio control plane (base + istiod)
  - name: istio
    manifests:
      helm:
        releases:
          - name: istio-base
            remoteChart: base
            repo: https://istio-release.storage.googleapis.com/charts
            namespace: istio-system
            createNamespace: true
            upgradeOnChange: true
            wait: true
            version: 1.16.7
          - name: istiod
            remoteChart: istiod
            repo: https://istio-release.storage.googleapis.com/charts
            namespace: istio-system
            createNamespace: true
            upgradeOnChange: true
            wait: true
            version: 1.16.7

  # Profile for running with webhook enabled
  - name: webhook
    manifests:
      helm:
        releases:
          - name: mariadb-operator-crds
            chartPath: deploy/charts/mariadb-operator-crds
            namespace: mariadb-system
            createNamespace: true
            upgradeOnChange: true
            wait: true
            version: 25.10.2
          - name: mariadb-operator
            chartPath: deploy/charts/mariadb-operator
            namespace: mariadb-system
            createNamespace: true
            upgradeOnChange: true
            wait: true
            setValueTemplates:
              image.repository: mariadb-operator
              image.tag: "{{.IMAGE_TAG}}"
              image.pullPolicy: IfNotPresent
            setValues:
              webhook.enabled: true
              certController.enabled: true
              logLevel: DEBUG
              ha.enabled: false
            version: 25.10.2
          - name: mariadb-cluster
            chartPath: deploy/charts/mariadb-cluster
            namespace: default
            upgradeOnChange: true
            wait: true
            setValues:
              mariadb.replicas: 1
              mariadb.galera.enabled: false
              mariadb.storage.size: 2Gi
            version: 25.10.2

  # Profile for Galera cluster (3 replicas)
  - name: galera
    manifests:
      helm:
        releases:
          - name: mariadb-operator-crds
            chartPath: deploy/charts/mariadb-operator-crds
            namespace: mariadb-system
            createNamespace: true
            upgradeOnChange: true
            wait: true
            version: 25.10.2
          - name: mariadb-operator
            chartPath: deploy/charts/mariadb-operator
            namespace: mariadb-system
            createNamespace: true
            upgradeOnChange: true
            wait: true
            setValueTemplates:
              image.repository: mariadb-operator
              image.tag: "{{.IMAGE_TAG}}"
              image.pullPolicy: IfNotPresent
            setValues:
              webhook.enabled: false
              certController.enabled: false
              logLevel: DEBUG
              ha.enabled: false
            version: 25.10.2
          - name: mariadb-cluster
            chartPath: deploy/charts/mariadb-cluster
            namespace: default
            upgradeOnChange: true
            wait: true
            setValues:
              mariadb.replicas: 3
              mariadb.galera.enabled: true
              mariadb.storage.size: 2Gi
            version: 25.10.2

  # Profile for replication setup (1 primary, 2 replicas)
  - name: replication
    manifests:
      helm:
        releases:
          - name: mariadb-operator-crds
            chartPath: deploy/charts/mariadb-operator-crds
            namespace: mariadb-system
            createNamespace: true
            upgradeOnChange: true
            wait: true
            version: 25.10.2
          - name: mariadb-operator
            chartPath: deploy/charts/mariadb-operator
            namespace: mariadb-system
            createNamespace: true
            upgradeOnChange: true
            wait: true
            setValueTemplates:
              image.repository: mariadb-operator
              image.tag: "{{.IMAGE_TAG}}"
              image.pullPolicy: IfNotPresent
            setValues:
              webhook.enabled: false
              certController.enabled: false
              logLevel: DEBUG
              ha.enabled: false
            version: 25.10.2
          - name: mariadb-cluster
            chartPath: deploy/charts/mariadb-cluster
            namespace: default
            upgradeOnChange: true
            wait: true
            setValues:
              mariadb.replicas: 3
              mariadb.galera.enabled: false
              mariadb.replication.enabled: true
              mariadb.storage.size: 2Gi
              mariadb.rootPasswordSecretKeyRef.name: mariadb
              mariadb.rootPasswordSecretKeyRef.key: root-password
              # Create test database automatically via Database CR
              databases:
                - name: test
                  characterSet: utf8mb4
                  collate: utf8mb4_unicode_ci
              # Create app user without SUPER privilege for realistic testing
              users:
                - name: appuser
                  passwordSecretKeyRef:
                    name: mariadb
                    key: app-password
                  maxUserConnections: 100
              grants:
                - name: appuser-test-grant
                  database: test
                  table: "*"
                  username: appuser
                  privileges:
                    - SELECT
                    - INSERT
                    - UPDATE
                    - DELETE
                    - CREATE
                    - DROP
                    - INDEX
                    - ALTER
              # Note: Replication config would need additional CRs
              # See examples/manifests/mariadb_replication.yaml
            version: 25.10.2
          - name: mariadb-test-client
            chartPath: test/client/chart
            namespace: default
            upgradeOnChange: true
            wait: false
            setValueTemplates:
              image: "{{.IMAGE_FULLY_QUALIFIED_mariadb_test_client}}"
            setValues:
              imagePullPolicy: IfNotPresent
              # Connect to primary service for replication testing
              mariadb.host: mariadb-cluster-primary
              mariadb.port: 3306
              mariadb.user: appuser
              mariadb.passwordSecret.name: mariadb
              mariadb.passwordSecret.key: app-password
              mariadb.database: test
              client.writeInterval: 0.5

  # Profile for production-like setup with metrics
  - name: production
    manifests:
      helm:
        releases:
          - name: mariadb-operator-crds
            chartPath: deploy/charts/mariadb-operator-crds
            namespace: mariadb-system
            createNamespace: true
            upgradeOnChange: true
            wait: true
            version: 25.10.2
          - name: mariadb-operator
            chartPath: deploy/charts/mariadb-operator
            namespace: mariadb-system
            createNamespace: true
            upgradeOnChange: true
            wait: true
            setValueTemplates:
              image.repository: mariadb-operator
              image.tag: "{{.IMAGE_TAG}}"
              image.pullPolicy: IfNotPresent
            setValues:
              webhook.enabled: true
              certController.enabled: true
              logLevel: INFO
              ha.enabled: true
              ha.replicas: 3
              metrics.enabled: true
              metrics.serviceMonitor.enabled: true
            version: 25.10.2
          - name: mariadb-cluster
            chartPath: deploy/charts/mariadb-cluster
            namespace: default
            upgradeOnChange: true
            wait: true
            setValues:
              mariadb.replicas: 3
              mariadb.galera.enabled: true
              mariadb.storage.size: 10Gi
            version: 25.10.2
    portForward:
      - resourceType: service
        resourceName: mariadb-operator
        namespace: mariadb-system
        port: 8080
        localPort: 8080
      - resourceType: service
        resourceName: mariadb-cluster
        namespace: default
        port: 3306
        localPort: 3306
